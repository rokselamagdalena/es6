/**
 * Created by ZSY on 2017/3/26.
 */

const server = require('./server');

function refreshAfterHtmlChange(options) {
  this.res = server(options);
  this.init = false;
  this.refresh = false;
}

refreshAfterHtmlChange.prototype.apply = function(compiler) {
  const self = this;
  compiler.plugin('compilation', compilation => {
    compilation.plugin('html-webpack-plugin-after-html-processing', (htmlWebpackData, callback) => {
      if (self.init) {
        self.refresh = true;
      }
      callback(null, htmlWebpackData);
    });
  });
  compiler.plugin('done', () => {
    if (self.init && self.refresh) {
      self.refresh = false;
      self.res.publish('reload');
    }
    self.init = true;
  })
};

module.exports = refreshAfterHtmlChange;