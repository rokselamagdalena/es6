/**
 * Created by ZSY on 2017/3/26.
 */

const http = require('http'),
      fs   = require('fs');

module.exports = function () {
  let clients = {};
  let clientId = 0;

  http.createServer(function (req, res) {
    const url = req.url;
    if (url === '/stream') {
      res.writeHead(200, {
        'Access-Control-Allow-Origin': '*',
        "Content-Type": "text/event-stream",
        "Cache-Control": "no-cache",
        "Connection": "keep-alive"
      });

      res.write('retry: 100000\n');
      res.write('data: connect\n\n');

      const thisID = ++clientId;
      clients[thisID] = res;

      const interval = setInterval(() => {
        res.write("data: \uD83D\uDC93\n\n");
      }, 10000);

      req.connection.addListener("close", () => {
        delete clients[thisID];
        clearInterval(interval);
      }, false);
    }
  }).listen(3101);

  return {
    publish: payload => {
      Object.keys(clients).forEach(clientId => {
        if(clients[clientId]) {
          clients[clientId].write(`data: ${payload}\n\n`);
        }
      });
    }
  };
};